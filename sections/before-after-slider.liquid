<style>
.image-compare-wrapper {
  padding: 40px 0;
}

.image-compare {
  position: relative;
  width: 100%;
  height: {{ section.settings.desktop_height }}px;
  overflow: hidden;
  border-radius: 14px;
}

@media (max-width: 768px) {
  .image-compare {
    height: {{ section.settings.mobile_height }}px;
  }
}

.image-layer {
  position: absolute;
  inset: 0;
}

.image-layer img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
}

/* Before */
.image-before {
  z-index: 2;
  clip-path: polygon(0 0, 50% 0, 50% 100%, 0 100%);
}

/* After */
.image-after {
  z-index: 1;
}

/* Slider */
.compare-slider {
  position: absolute;
  top: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 4px;
  height: 100%;
  background: #fff;
  z-index: 5;
  cursor: ew-resize;
}

/* Handle */
.compare-handle {
  position: absolute;
  top: 50%;
  left: 50%;
  width: 56px;
  height: 56px;
  background: #fff;
  border-radius: 50%;
  transform: translate(-50%, -50%);
  box-shadow: 0 8px 20px rgba(0,0,0,.25);
}

.compare-handle::before,
.compare-handle::after {
  content: '';
  position: absolute;
  width: 0;
  height: 0;
  border-style: solid;
}

.compare-handle::before {
  border-width: 7px 9px 7px 0;
  border-color: transparent #000 transparent transparent;
  left: 16px;
}

.compare-handle::after {
  border-width: 7px 0 7px 9px;
  border-color: transparent transparent transparent #000;
  right: 16px;
}

/* Labels */
.compare-label {
  position: absolute;
  bottom: 20px;
  padding: 6px 14px;
  background: rgba(0,0,0,.55);
  color: #fff;
  font-size: 14px;
  font-weight: 600;
  border-radius: 999px;
  z-index: 6;
}

.compare-label.before { left: 20px; }
.compare-label.after { right: 20px; }
</style>

<div class="image-compare-wrapper">
  <div class="image-compare" id="compare-{{ section.id }}">

    <!-- AFTER IMAGE -->
    <div class="image-layer image-after">
      {% if section.settings.after_image != blank %}
        <img
          src="{{ section.settings.after_image | image_url: width: 1600 }}"
          alt="{{ section.settings.after_label | escape }}"
          width="{{ section.settings.after_image.width }}"
          height="{{ section.settings.after_image.height }}"
          loading="lazy"
        >
      {% endif %}
    </div>

    <!-- BEFORE IMAGE -->
    <div class="image-layer image-before">
      {% if section.settings.before_image != blank %}
        <img
          src="{{ section.settings.before_image | image_url: width: 1600 }}"
          alt="{{ section.settings.before_label | escape }}"
          width="{{ section.settings.before_image.width }}"
          height="{{ section.settings.before_image.height }}"
          loading="lazy"
        >
      {% endif %}
    </div>

    <!-- SLIDER -->
    <div class="compare-slider">
      <div class="compare-handle"></div>
    </div>

    {% if section.settings.show_labels %}
      <div class="compare-label before">{{ section.settings.before_label }}</div>
      <div class="compare-label after">{{ section.settings.after_label }}</div>
    {% endif %}

  </div>
</div>

<script>
(function(){
  const container = document.getElementById('compare-{{ section.id }}');
  if (!container) return;

  const slider = container.querySelector('.compare-slider');
  const before = container.querySelector('.image-before');
  let dragging = false;

  function move(x){
    const rect = container.getBoundingClientRect();
    let percent = ((x - rect.left) / rect.width) * 100;
    percent = Math.max(0, Math.min(100, percent));
    slider.style.left = percent + '%';
    before.style.clipPath =
      `polygon(0 0, ${percent}% 0, ${percent}% 100%, 0 100%)`;
  }

  slider.addEventListener('mousedown', () => dragging = true);
  document.addEventListener('mouseup', () => dragging = false);
  document.addEventListener('mousemove', e => dragging && move(e.clientX));

  slider.addEventListener('touchstart', () => dragging = true);
  document.addEventListener('touchend', () => dragging = false);
  document.addEventListener('touchmove', e => dragging && move(e.touches[0].clientX));
})();
</script>

{% schema %}
{
  "name": "Before After Image Slider",
  "settings": [
    {
      "type": "image_picker",
      "id": "before_image",
      "label": "Before Image"
    },
    {
      "type": "image_picker",
      "id": "after_image",
      "label": "After Image"
    },
    {
      "type": "checkbox",
      "id": "show_labels",
      "label": "Show Labels",
      "default": true
    },
    {
      "type": "text",
      "id": "before_label",
      "label": "Before Label",
      "default": "Before"
    },
    {
      "type": "text",
      "id": "after_label",
      "label": "After Label",
      "default": "After"
    },
    {
      "type": "range",
      "id": "desktop_height",
      "label": "Desktop Height",
      "min": 400,
      "max": 800,
      "step": 20,
      "default": 640
    },
    {
      "type": "range",
      "id": "mobile_height",
      "label": "Mobile Height",
      "min": 250,
      "max": 500,
      "step": 10,
      "default": 400
    }
  ],
  "presets": [
    {
      "name": "Before / After Comparison"
    }
  ]
}
{% endschema %}
