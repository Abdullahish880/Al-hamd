{% schema %}
{
  "name": "COD Button Section",
  "settings": [
    {
      "type": "text",
      "id": "button_text",
      "label": "Button Text",
      "default": "Cash on Delivery"
    }
  ],
  "presets": [
    {
      "name": "COD Button"
    }
  ]
}
{% endschema %}

<div class="cod-section">
  <button id="cod-button" class="cod-button">{{ section.settings.button_text }}</button>

  <!-- Modal -->
  <div id="cod-modal" class="cod-modal">
    <div class="cod-modal-content">
      <span id="cod-close" class="cod-close">&times;</span>
      <h2>Cash on Delivery Form</h2>
      <form id="cod-form">
        <label>Full Name: <input type="text" name="name" required></label>
        <label>Address: <input type="text" name="address" required></label>
        <label>Delivery Method:
          <select id="delivery-method" name="delivery_method" required>
            <option value="">Select</option>
            <option value="standard">Standard Delivery</option>
            <option value="express">Express Delivery</option>
            <option value="pickup">Store Pickup</option>
          </select>
        </label>
        <div id="method-details"></div>
        <button type="submit">Checkout with COD</button>
      </form>
    </div>
  </div>
</div>

<style>
.cod-button { background:#ff5a5f; color:#fff; padding:12px 20px; border:none; cursor:pointer; border-radius:5px; }
.cod-modal { display:none; position:fixed; z-index:9999; left:0; top:0; width:100%; height:100%; background: rgba(0,0,0,0.6); }
.cod-modal-content { background:#fff; margin:10% auto; padding:20px; border-radius:10px; width:90%; max-width:500px; position:relative; }
.cod-close { position:absolute; top:10px; right:15px; font-size:25px; cursor:pointer; }
#method-details label { display:block; margin-top:10px; }
</style>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const codButton = document.getElementById("cod-button");
  const codModal = document.getElementById("cod-modal");
  const codClose = document.getElementById("cod-close");
  const deliverySelect = document.getElementById("delivery-method");
  const methodDetails = document.getElementById("method-details");
  const codForm = document.getElementById("cod-form");

  // Open modal
  codButton.addEventListener("click", () => codModal.style.display="block");
  codClose.addEventListener("click", () => codModal.style.display="none");
  window.addEventListener("click", e => { if(e.target==codModal) codModal.style.display="none"; });

  // Dynamic delivery fields
  deliverySelect.addEventListener("change", () => {
    const method = deliverySelect.value;
    methodDetails.innerHTML = "";
    if(method==="express") methodDetails.innerHTML = `
      <label>Express Fee: <input type="number" name="express_fee" required></label>
      <label>Preferred Time: <input type="time" name="delivery_time"></label>
    `;
    else if(method==="pickup") methodDetails.innerHTML = `
      <label>Pickup Location:
        <select name="pickup_location" required>
          <option value="store1">Store 1</option>
          <option value="store2">Store 2</option>
        </select>
      </label>
    `;
    else if(method==="standard") methodDetails.innerHTML = `
      <label>Additional Instructions: <textarea name="instructions"></textarea></label>
    `;
  });

  // Form submission â†’ AJAX add to cart + redirect
  codForm.addEventListener("submit", async e => {
    e.preventDefault();

    // Get first product variant ID from product page
    const variantInput = document.querySelector('input[name="id"]');
    if(!variantInput){ alert("Cannot find product variant."); return; }
    const variantId = variantInput.value;

    // Collect form data
    const formData = new FormData(codForm);
    const attributes = {};
    formData.forEach((v,k)=>attributes[k]=v);

    // AJAX request to add product to cart with attributes
    try {
      await fetch('/cart/add.js', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          items: [{ id: variantId, quantity: 1 }],
          attributes: attributes
        })
      });

      // Redirect to checkout page
      window.location.href = '/checkout';
    } catch(err){
      console.error(err);
      alert("Failed to add to cart.");
    }
  });
});
</script>
